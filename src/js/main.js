(function() {
    'use strict';

    const FIELD_CODES = {
        TASK_NAME: 'task_name',
        PROJECT_NAME: 'project_name', 
        START_DATE: 'start_date',
        END_DATE: 'end_date',
        TASK_TYPE: 'task_type',
        STATUS: 'status',
        ASSIGNEE: 'assignee',
        DESCRIPTION: 'description',
        PRIORITY: 'priority',
        PROJECT_COLOR: 'project_color'
    };

    const TASK_TYPES = {
        SINGLE: 'ÂçòÁô∫',
        DAILY: '„Éá„Ç§„É™„Éº'
    };

    const STATUS_TYPES = {
        NOT_STARTED: 'Êú™ÁùÄÊâã',
        IN_PROGRESS: 'ÈÄ≤Ë°å‰∏≠', 
        COMPLETED: 'ÂÆå‰∫Ü'
    };

    window.FIELD_CODES = FIELD_CODES;
    window.TASK_TYPES = TASK_TYPES;
    window.STATUS_TYPES = STATUS_TYPES;

    kintone.events.on('app.record.index.show', function(event) {
        if (event.viewName !== '„Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫') {
            return event;
        }

        setTimeout(() => {
            initializeTaskCalendar();
        }, 100);
        
        return event;
    });

    function initializeTaskCalendar() {
        loadRequiredLibraries().then(() => {
            setupCalendarContainer();
            initializeAllManagers();
        });
    }

    function loadRequiredLibraries() {
        return Promise.all([
            loadFullCalendar(),
            loadCustomStyles()
        ]);
    }

    function loadFullCalendar() {
        return new Promise((resolve) => {
            if (window.FullCalendar) {
                resolve();
                return;
            }

            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css';
            document.head.appendChild(link);

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js';
            script.onload = resolve;
            document.head.appendChild(script);
        });
    }

    function loadCustomStyles() {
        return new Promise((resolve) => {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '/k/files/calendar.css';
            link.onload = resolve;
            link.onerror = resolve;
            document.head.appendChild(link);
        });
    }

    function setupCalendarContainer() {
        const headerSpace = kintone.app.getHeaderSpaceElement();
        if (!headerSpace) return;

        headerSpace.innerHTML = `
            <div id="task-calendar-app">
                <div id="calendar-header">
                    <h2>„Çø„Çπ„ÇØ„Ç´„É¨„É≥„ÉÄ„Éº</h2>
                    <div class="header-actions">
                        <button id="manage-background" class="btn btn-warning">üñºÔ∏è ËÉåÊôØË®≠ÂÆö</button>
                        <button id="manage-projects" class="btn btn-info">üìÅ Ê°à‰ª∂ÁÆ°ÁêÜ</button>
                        <button id="quick-add-task" class="btn btn-success">+ Êñ∞Ë¶è„Çø„Çπ„ÇØ</button>
                        <button id="toggle-view-options" class="btn btn-outline">Ë°®Á§∫Ë®≠ÂÆö</button>
                    </div>
                </div>
                
                <div id="calendar-controls">
                    <div class="basic-filters">
                        <select id="project-filter">
                            <option value="">ÂÖ®Ê°à‰ª∂</option>
                        </select>
                        <select id="task-type-filter">
                            <option value="">ÂÖ®Á®ÆÂà•</option>
                            <option value="${TASK_TYPES.SINGLE}">${TASK_TYPES.SINGLE}</option>
                            <option value="${TASK_TYPES.DAILY}">${TASK_TYPES.DAILY}</option>
                        </select>
                        <button id="refresh-calendar" class="btn btn-primary">Êõ¥Êñ∞</button>
                    </div>
                </div>
                
                <div id="view-options" class="view-options" style="display: none;">
                    <div class="option-group">
                        <label>
                            <input type="checkbox" id="show-weekends" checked> 
                            ÈÄ±Êú´Ë°®Á§∫
                        </label>
                        <label>
                            <input type="checkbox" id="show-completed" checked> 
                            ÂÆå‰∫Ü„Çø„Çπ„ÇØË°®Á§∫
                        </label>
                        <label>
                            <input type="checkbox" id="show-task-icons" checked> 
                            „Çø„Çπ„ÇØ„Ç¢„Ç§„Ç≥„É≥Ë°®Á§∫
                        </label>
                    </div>
                </div>
                
                <div class="calendar-layout">
                    <div class="calendar-sidebar left-sidebar">
                        <div class="sidebar-background" id="left-background"></div>
                        <div class="sidebar-content">
                            <h4>üìà ÈÄ≤ÊçóÁä∂Ê≥Å</h4>
                            <div id="progress-stats"></div>
                        </div>
                    </div>
                    <div id="calendar"></div>
                    <div class="calendar-sidebar right-sidebar">
                        <div class="sidebar-background" id="right-background"></div>
                        <div class="sidebar-content">
                            <h4>üìù „É°„É¢</h4>
                            <div id="memo-area">
                                <textarea id="daily-memo" placeholder="‰ªäÊó•„ÅÆ„É°„É¢..."></textarea>
                                <button id="save-memo" class="btn btn-sm">‰øùÂ≠ò</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="task-summary">
                    <div class="summary-cards">
                        <div class="summary-card" id="today-tasks">
                            <h4>‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ</h4>
                            <div class="task-count">0</div>
                        </div>
                        <div class="summary-card" id="overdue-tasks">
                            <h4>ÊúüÈôêË∂ÖÈÅé</h4>
                            <div class="task-count">0</div>
                        </div>
                        <div class="summary-card" id="upcoming-tasks">
                            <h4>‰ªäÈÄ±„ÅÆ‰∫àÂÆö</h4>
                            <div class="task-count">0</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶Ë®≠ÂÆö
        setTimeout(() => {
            setupEventListeners();
        }, 100);
    }

    function setupEventListeners() {
        console.log('Setting up event listeners...');
        
        // ÂÆâÂÖ®„Å´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        const addListener = (id, event, handler) => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener(event, handler);
                console.log(`Event listener added for ${id}`);
            } else {
                console.error(`Element not found: ${id}`);
            }
        };
        
        addListener('manage-background', 'click', openBackgroundManager);
        addListener('manage-projects', 'click', openProjectManager);
        addListener('quick-add-task', 'click', openTaskCreationDialog);
        addListener('toggle-view-options', 'click', toggleViewOptions);
        addListener('show-weekends', 'change', toggleWeekends);
        addListener('show-completed', 'change', toggleCompleted);
        addListener('show-task-icons', 'change', toggleTaskIcons);
        addListener('save-memo', 'click', saveDailyMemo);
        addListener('refresh-calendar', 'click', () => loadInitialData());
        addListener('project-filter', 'change', () => displayTasksOnCalendar());
        addListener('task-type-filter', 'change', () => displayTasksOnCalendar());
    }

    function initializeAllManagers() {
        if (window.FilterManager) {
            FilterManager.init();
        }
        
        if (window.TaskManager) {
            TaskManager.init();
        }
        
        if (window.DragDropManager) {
            DragDropManager.init();
        }
        
        initializeMainCalendar();
    }

    function initializeMainCalendar() {
        const calendarEl = document.getElementById('calendar');
        
        window.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            locale: 'ja',
            height: 'auto',
            editable: true,
            droppable: true,
            selectable: true,
            selectMirror: true,
            eventDrop: handleEventDrop,
            eventResize: handleEventResize,
            eventClick: handleEventClick,
            dateClick: handleDateClick,
            select: handleDateSelect,
            eventDidMount: customizeEventAppearance,
            dayCellDidMount: customizeDayCell
        });

        calendar.render();
        
        if (window.DragDropManager) {
            DragDropManager.enableDragDrop(calendar);
        }
        
        loadInitialData();
        
        // ‰øùÂ≠ò„Åï„Çå„ÅüËÉåÊôØÁîªÂÉè„ÇíÈÅ©Áî®
        setTimeout(() => {
            applyBackgroundsToCalendar();
            loadDailyMemo();
        }, 500);
    }

    function loadDailyMemo() {
        const today = new Date().toISOString().split('T')[0];
        const savedMemo = localStorage.getItem(`calendar-memo-${today}`);
        
        const memoArea = document.getElementById('daily-memo');
        if (memoArea && savedMemo) {
            memoArea.value = savedMemo;
        }
    }

    function loadInitialData() {
        TaskAPI.getTasks().then(response => {
            window.currentTasks = response.records;
            displayTasksOnCalendar();
            updateTaskSummary();
            
            if (window.FilterManager) {
                FilterManager.updateFilters();
            }
        });
    }

    function displayTasksOnCalendar() {
        calendar.removeAllEvents();
        
        const filteredTasks = getFilteredTasks();
        const events = filteredTasks.map(task => createCalendarEvent(task));
        
        calendar.addEventSource(events);
        updateTaskSummary(filteredTasks);
    }

    function getFilteredTasks() {
        if (!window.currentTasks) return [];
        
        const projectFilter = document.getElementById('project-filter').value;
        const taskTypeFilter = document.getElementById('task-type-filter').value;
        const showCompleted = document.getElementById('show-completed').checked;
        
        return currentTasks.filter(task => {
            const projectMatch = !projectFilter || task[FIELD_CODES.PROJECT_NAME].value === projectFilter;
            const taskTypeMatch = !taskTypeFilter || task[FIELD_CODES.TASK_TYPE].value === taskTypeFilter;
            const completedMatch = showCompleted || task[FIELD_CODES.STATUS].value !== STATUS_TYPES.COMPLETED;
            
            return projectMatch && taskTypeMatch && completedMatch;
        });
    }

    function createCalendarEvent(task) {
        const startDate = new Date(task[FIELD_CODES.START_DATE].value);
        const endDate = task[FIELD_CODES.END_DATE].value ? new Date(task[FIELD_CODES.END_DATE].value) : null;
        
        return {
            id: task.$id.value,
            title: task[FIELD_CODES.TASK_NAME].value,
            start: startDate,
            end: endDate,
            allDay: !endDate,
            backgroundColor: task[FIELD_CODES.PROJECT_COLOR].value || getDefaultProjectColor(task[FIELD_CODES.PROJECT_NAME].value),
            borderColor: task[FIELD_CODES.PROJECT_COLOR].value || getDefaultProjectColor(task[FIELD_CODES.PROJECT_NAME].value),
            extendedProps: {
                project_name: task[FIELD_CODES.PROJECT_NAME].value,
                task_type: task[FIELD_CODES.TASK_TYPE].value,
                status: task[FIELD_CODES.STATUS].value,
                priority: task[FIELD_CODES.PRIORITY].value,
                assignee: task[FIELD_CODES.ASSIGNEE].value,
                description: task[FIELD_CODES.DESCRIPTION].value,
                record_id: task.$id.value
            },
            className: [
                `status-${task[FIELD_CODES.STATUS].value}`,
                `priority-${task[FIELD_CODES.PRIORITY].value}`,
                `task-type-${task[FIELD_CODES.TASK_TYPE].value}`
            ]
        };
    }

    function getDefaultProjectColor(projectName) {
        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22'];
        const hash = projectName.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
        return colors[hash % colors.length];
    }

    function customizeEventAppearance(info) {
        const showIcons = document.getElementById('show-task-icons').checked;
        
        if (showIcons) {
            const taskType = info.event.extendedProps.task_type;
            const priority = info.event.extendedProps.priority;
            
            let icon = '';
            if (taskType === TASK_TYPES.DAILY) {
                icon = 'üîÑ ';
            } else {
                icon = 'üìã ';
            }
            
            if (priority === 'È´ò') {
                icon += '‚ö°';
            }
            
            const titleEl = info.el.querySelector('.fc-event-title');
            if (titleEl) {
                titleEl.textContent = icon + titleEl.textContent;
            }
        }
    }

    function customizeDayCell(info) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (info.date.getTime() === today.getTime()) {
            info.el.classList.add('fc-day-today-custom');
        }
    }

    function updateTaskSummary(tasks = currentTasks) {
        if (!tasks) return;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const todayTasks = tasks.filter(task => {
            const taskDate = new Date(task[FIELD_CODES.START_DATE].value);
            taskDate.setHours(0, 0, 0, 0);
            return taskDate.getTime() === today.getTime() && task[FIELD_CODES.STATUS].value !== STATUS_TYPES.COMPLETED;
        });
        
        const overdueTasks = tasks.filter(task => {
            const taskDate = new Date(task[FIELD_CODES.START_DATE].value);
            return taskDate < today && task[FIELD_CODES.STATUS].value !== STATUS_TYPES.COMPLETED;
        });
        
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        const upcomingTasks = tasks.filter(task => {
            const taskDate = new Date(task[FIELD_CODES.START_DATE].value);
            return taskDate > today && taskDate <= nextWeek && task[FIELD_CODES.STATUS].value !== STATUS_TYPES.COMPLETED;
        });
        
        document.querySelector('#today-tasks .task-count').textContent = todayTasks.length;
        document.querySelector('#overdue-tasks .task-count').textContent = overdueTasks.length;
        document.querySelector('#upcoming-tasks .task-count').textContent = upcomingTasks.length;
    }

    function handleEventDrop(info) {
        if (window.DragDropManager) {
            DragDropManager.handleTaskDrop({
                recordId: info.event.extendedProps.record_id,
                title: info.event.title,
                taskType: info.event.extendedProps.task_type
            }, info.event.start);
        }
    }

    function handleEventResize(info) {
        const recordId = info.event.extendedProps.record_id;
        const updateData = {
            [FIELD_CODES.START_DATE]: info.event.start.toISOString(),
            [FIELD_CODES.END_DATE]: info.event.end ? info.event.end.toISOString() : null
        };

        TaskAPI.updateTask(recordId, updateData)
            .then(() => {
                showNotification('„Çø„Çπ„ÇØÊúüÈñì„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
            })
            .catch((error) => {
                console.error('„Çø„Çπ„ÇØÊúüÈñìÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                info.revert();
                showNotification('„Çø„Çπ„ÇØÊúüÈñì„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            });
    }

    function handleEventClick(info) {
        const recordId = info.event.extendedProps.record_id;
        const url = `${location.origin}/k/${kintone.app.getId()}/show#record=${recordId}`;
        
        if (info.jsEvent.ctrlKey || info.jsEvent.metaKey) {
            window.open(url, '_blank');
        } else {
            location.href = url;
        }
    }

    function handleDateClick(info) {
        openQuickTaskDialog(info.date);
    }

    function handleDateSelect(info) {
        openQuickTaskDialog(info.start, info.end);
    }

    function openQuickTaskDialog(startDate, endDate = null) {
        const modal = createQuickTaskModal(startDate, endDate);
        document.body.appendChild(modal);
    }

    function createQuickTaskModal(startDate, endDate) {
        const modal = document.createElement('div');
        modal.className = 'task-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Êñ∞Ë¶è„Çø„Çπ„ÇØ‰ΩúÊàê</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="quick-task-form">
                        <div class="form-row">
                            <label>„Çø„Çπ„ÇØÂêç:</label>
                            <input type="text" id="quick-task-name" required>
                        </div>
                        <div class="form-row">
                            <label>Ê°à‰ª∂:</label>
                            <select id="quick-project-name" required></select>
                        </div>
                        <div class="form-row">
                            <label>ÈñãÂßãÊó•:</label>
                            <input type="datetime-local" id="quick-start-date" 
                                   value="${startDate.toISOString().slice(0, 16)}" required>
                        </div>
                        <div class="form-row">
                            <label>ÁµÇ‰∫ÜÊó•:</label>
                            <input type="datetime-local" id="quick-end-date" 
                                   value="${endDate ? endDate.toISOString().slice(0, 16) : ''}">
                        </div>
                        <div class="form-row">
                            <label>„Çø„Çπ„ÇØÁ®ÆÂà•:</label>
                            <select id="quick-task-type">
                                <option value="${TASK_TYPES.SINGLE}">${TASK_TYPES.SINGLE}</option>
                                <option value="${TASK_TYPES.DAILY}">${TASK_TYPES.DAILY}</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>ÂÑ™ÂÖàÂ∫¶:</label>
                            <select id="quick-priority">
                                <option value="‰∏≠">‰∏≠</option>
                                <option value="È´ò">È´ò</option>
                                <option value="‰Ωé">‰Ωé</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" form="quick-task-form" class="btn btn-primary">‰ΩúÊàê</button>
                </div>
            </div>
        `;

        setupModalEventListeners(modal);
        loadProjectOptions();
        
        return modal;
    }

    function setupModalEventListeners(modal) {
        modal.querySelector('.close-btn').addEventListener('click', () => closeModal(modal));
        modal.querySelector('.close-modal').addEventListener('click', () => closeModal(modal));
        modal.querySelector('#quick-task-form').addEventListener('submit', (e) => handleQuickTaskSubmit(e, modal));
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(modal);
        });
    }

    function closeModal(modal) {
        document.body.removeChild(modal);
    }

    function handleQuickTaskSubmit(e, modal) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const taskData = {
            [FIELD_CODES.TASK_NAME]: document.getElementById('quick-task-name').value,
            [FIELD_CODES.PROJECT_NAME]: document.getElementById('quick-project-name').value,
            [FIELD_CODES.START_DATE]: document.getElementById('quick-start-date').value,
            [FIELD_CODES.END_DATE]: document.getElementById('quick-end-date').value || null,
            [FIELD_CODES.TASK_TYPE]: document.getElementById('quick-task-type').value,
            [FIELD_CODES.STATUS]: STATUS_TYPES.NOT_STARTED,
            [FIELD_CODES.PRIORITY]: document.getElementById('quick-priority').value
        };

        TaskAPI.createTask(taskData)
            .then(() => {
                closeModal(modal);
                loadInitialData();
                showNotification('„Çø„Çπ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü', 'success');
            })
            .catch((error) => {
                console.error('„Çø„Çπ„ÇØ‰ΩúÊàê„Ç®„É©„Éº:', error);
                showNotification('„Çø„Çπ„ÇØ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            });
    }

    function loadProjectOptions() {
        TaskAPI.getProjects().then(projects => {
            const select = document.getElementById('quick-project-name');
            select.innerHTML = '<option value="">Ê°à‰ª∂„ÇíÈÅ∏Êäû</option>';
            
            projects.forEach(project => {
                select.innerHTML += `<option value="${project}">${project}</option>`;
            });
        });
    }

    function toggleViewOptions() {
        const options = document.getElementById('view-options');
        const button = document.getElementById('toggle-view-options');
        
        if (options.style.display === 'none') {
            options.style.display = 'block';
            button.textContent = 'Ë°®Á§∫Ë®≠ÂÆö„ÇíÈñâ„Åò„Çã';
        } else {
            options.style.display = 'none';
            button.textContent = 'Ë°®Á§∫Ë®≠ÂÆö';
        }
    }

    function toggleWeekends() {
        const showWeekends = document.getElementById('show-weekends').checked;
        calendar.setOption('weekends', showWeekends);
    }

    function toggleCompleted() {
        displayTasksOnCalendar();
    }

    function toggleTaskIcons() {
        displayTasksOnCalendar();
    }

    function openBackgroundManager() {
        const modal = createBackgroundManagerModal();
        document.body.appendChild(modal);
    }

    function createBackgroundManagerModal() {
        const modal = document.createElement('div');
        modal.className = 'task-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üñºÔ∏è ËÉåÊôØÁîªÂÉèË®≠ÂÆö</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="background-manager">
                        <div class="background-section">
                            <h4>Â∑¶ÂÅ¥„ÅÆËÉåÊôØÁîªÂÉè</h4>
                            <div class="upload-area">
                                <input type="file" id="left-image-upload" accept="image/*" style="display: none;">
                                <button type="button" class="upload-btn" onclick="document.getElementById('left-image-upload').click()">
                                    üìÅ ÁîªÂÉè„ÇíÈÅ∏Êäû
                                </button>
                                <div class="preview-area">
                                    <div id="left-preview" class="image-preview">„Éó„É¨„Éì„É•„Éº„Å™„Åó</div>
                                    <button type="button" id="remove-left-bg" class="btn btn-sm btn-danger" style="display: none;">ÂâäÈô§</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="background-section">
                            <h4>Âè≥ÂÅ¥„ÅÆËÉåÊôØÁîªÂÉè</h4>
                            <div class="upload-area">
                                <input type="file" id="right-image-upload" accept="image/*" style="display: none;">
                                <button type="button" class="upload-btn" onclick="document.getElementById('right-image-upload').click()">
                                    üìÅ ÁîªÂÉè„ÇíÈÅ∏Êäû
                                </button>
                                <div class="preview-area">
                                    <div id="right-preview" class="image-preview">„Éó„É¨„Éì„É•„Éº„Å™„Åó</div>
                                    <button type="button" id="remove-right-bg" class="btn btn-sm btn-danger" style="display: none;">ÂâäÈô§</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="background-options">
                            <h4>Ë°®Á§∫Ë®≠ÂÆö</h4>
                            <div class="option-group">
                                <label>
                                    <input type="checkbox" id="show-left-sidebar" checked> 
                                    Â∑¶„Çµ„Ç§„Éâ„Éê„ÉºË°®Á§∫
                                </label>
                                <label>
                                    <input type="checkbox" id="show-right-sidebar" checked> 
                                    Âè≥„Çµ„Ç§„Éâ„Éê„ÉºË°®Á§∫
                                </label>
                            </div>
                            <div class="form-group">
                                <label>ËÉåÊôØÈÄèÊòéÂ∫¶:</label>
                                <input type="range" id="background-opacity" min="0" max="100" value="50">
                                <span id="opacity-value">50%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal">Èñâ„Åò„Çã</button>
                    <button type="button" id="apply-backgrounds" class="btn btn-primary">ÈÅ©Áî®</button>
                </div>
            </div>
        `;

        setupBackgroundManagerEventListeners(modal);
        loadSavedBackgrounds();
        
        return modal;
    }

    function setupBackgroundManagerEventListeners(modal) {
        modal.querySelector('.close-btn').addEventListener('click', () => closeModal(modal));
        modal.querySelector('.close-modal').addEventListener('click', () => closeModal(modal));
        modal.querySelector('#apply-backgrounds').addEventListener('click', applyBackgroundSettings);
        
        // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        modal.querySelector('#left-image-upload').addEventListener('change', (e) => handleImageUpload(e, 'left'));
        modal.querySelector('#right-image-upload').addEventListener('change', (e) => handleImageUpload(e, 'right'));
        
        // ËÉåÊôØÂâäÈô§
        modal.querySelector('#remove-left-bg').addEventListener('click', () => removeBackground('left'));
        modal.querySelector('#remove-right-bg').addEventListener('click', () => removeBackground('right'));
        
        // ÈÄèÊòéÂ∫¶„Çπ„É©„Ç§„ÉÄ„Éº
        modal.querySelector('#background-opacity').addEventListener('input', function() {
            modal.querySelector('#opacity-value').textContent = this.value + '%';
        });
        
        // „Çµ„Ç§„Éâ„Éê„ÉºË°®Á§∫ÂàáÊõø
        modal.querySelector('#show-left-sidebar').addEventListener('change', toggleSidebarPreview);
        modal.querySelector('#show-right-sidebar').addEventListener('change', toggleSidebarPreview);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(modal);
        });
    }

    function handleImageUpload(event, side) {
        const file = event.target.files[0];
        if (!file) return;
        
        console.log(`Uploading ${side} image:`, file.name);
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageData = e.target.result;
            
            // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
            const preview = document.getElementById(`${side}-preview`);
            preview.style.backgroundImage = `url(${imageData})`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
            preview.textContent = '';
            
            // ÂâäÈô§„Éú„Çø„É≥Ë°®Á§∫
            document.getElementById(`remove-${side}-bg`).style.display = 'inline-block';
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            localStorage.setItem(`calendar-bg-${side}`, imageData);
        };
        
        reader.readAsDataURL(file);
    }

    function removeBackground(side) {
        const preview = document.getElementById(`${side}-preview`);
        preview.style.backgroundImage = '';
        preview.textContent = '„Éó„É¨„Éì„É•„Éº„Å™„Åó';
        
        document.getElementById(`remove-${side}-bg`).style.display = 'none';
        
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÇÇÂâäÈô§
        localStorage.removeItem(`calendar-bg-${side}`);
    }

    function loadSavedBackgrounds() {
        ['left', 'right'].forEach(side => {
            const savedImage = localStorage.getItem(`calendar-bg-${side}`);
            if (savedImage) {
                const preview = document.getElementById(`${side}-preview`);
                preview.style.backgroundImage = `url(${savedImage})`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
                preview.textContent = '';
                
                document.getElementById(`remove-${side}-bg`).style.display = 'inline-block';
            }
        });
        
        // ‰øùÂ≠ò„Åï„Çå„ÅüË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        const opacity = localStorage.getItem('calendar-bg-opacity') || '50';
        const showLeft = localStorage.getItem('calendar-show-left') !== 'false';
        const showRight = localStorage.getItem('calendar-show-right') !== 'false';
        
        document.getElementById('background-opacity').value = opacity;
        document.getElementById('opacity-value').textContent = opacity + '%';
        document.getElementById('show-left-sidebar').checked = showLeft;
        document.getElementById('show-right-sidebar').checked = showRight;
    }

    function applyBackgroundSettings() {
        const opacity = document.getElementById('background-opacity').value;
        const showLeft = document.getElementById('show-left-sidebar').checked;
        const showRight = document.getElementById('show-right-sidebar').checked;
        
        // Ë®≠ÂÆö„Çí‰øùÂ≠ò
        localStorage.setItem('calendar-bg-opacity', opacity);
        localStorage.setItem('calendar-show-left', showLeft);
        localStorage.setItem('calendar-show-right', showRight);
        
        // ÂÆüÈöõ„Å´ËÉåÊôØ„ÇíÈÅ©Áî®
        applyBackgroundsToCalendar();
        
        showNotification('ËÉåÊôØË®≠ÂÆö„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü', 'success');
        closeModal(document.querySelector('.task-modal'));
    }

    function applyBackgroundsToCalendar() {
        const leftBg = localStorage.getItem('calendar-bg-left');
        const rightBg = localStorage.getItem('calendar-bg-right');
        const opacity = localStorage.getItem('calendar-bg-opacity') || '50';
        const showLeft = localStorage.getItem('calendar-show-left') !== 'false';
        const showRight = localStorage.getItem('calendar-show-right') !== 'false';
        
        // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆË°®Á§∫/ÈùûË°®Á§∫
        const leftSidebar = document.querySelector('.left-sidebar');
        const rightSidebar = document.querySelector('.right-sidebar');
        
        if (leftSidebar) {
            leftSidebar.style.display = showLeft ? 'block' : 'none';
            if (leftBg) {
                const leftBgEl = document.getElementById('left-background');
                leftBgEl.style.backgroundImage = `url(${leftBg})`;
                leftBgEl.style.opacity = opacity / 100;
            }
        }
        
        if (rightSidebar) {
            rightSidebar.style.display = showRight ? 'block' : 'none';
            if (rightBg) {
                const rightBgEl = document.getElementById('right-background');
                rightBgEl.style.backgroundImage = `url(${rightBg})`;
                rightBgEl.style.opacity = opacity / 100;
            }
        }
    }

    function toggleSidebarPreview() {
        const showLeft = document.getElementById('show-left-sidebar').checked;
        const showRight = document.getElementById('show-right-sidebar').checked;
        
        // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢„ÅÆË°®Á§∫ÂàáÊõø
        const leftSection = document.querySelector('.background-section:first-child');
        const rightSection = document.querySelector('.background-section:last-child');
        
        if (leftSection) leftSection.style.opacity = showLeft ? '1' : '0.5';
        if (rightSection) rightSection.style.opacity = showRight ? '1' : '0.5';
    }

    function saveDailyMemo() {
        const memo = document.getElementById('daily-memo').value;
        const today = new Date().toISOString().split('T')[0];
        
        localStorage.setItem(`calendar-memo-${today}`, memo);
        showNotification('„É°„É¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
    }

    function openProjectManager() {
        const modal = createProjectManagerModal();
        document.body.appendChild(modal);
    }

    function createProjectManagerModal() {
        const modal = document.createElement('div');
        modal.className = 'task-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìÅ Ê°à‰ª∂ÁÆ°ÁêÜ</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="project-manager">
                        <div class="add-project-section">
                            <h4>Êñ∞Ë¶èÊ°à‰ª∂ËøΩÂä†</h4>
                            <div class="form-group">
                                <label>Ê°à‰ª∂Âêç:</label>
                                <input type="text" id="new-project-name" placeholder="‰æã: Web„Çµ„Ç§„Éà„É™„Éã„É•„Éº„Ç¢„É´">
                            </div>
                            <div class="form-group">
                                <label>Ê°à‰ª∂„Ç´„É©„Éº:</label>
                                <div class="color-picker">
                                    <input type="color" id="new-project-color" value="#4CAF50">
                                    <div class="color-presets">
                                        <div class="preset-color" data-color="#FF6B6B" style="background: #FF6B6B" title="Ëµ§"></div>
                                        <div class="preset-color" data-color="#4ECDC4" style="background: #4ECDC4" title="ÈùíÁ∑ë"></div>
                                        <div class="preset-color" data-color="#45B7D1" style="background: #45B7D1" title="Èùí"></div>
                                        <div class="preset-color" data-color="#96CEB4" style="background: #96CEB4" title="Á∑ë"></div>
                                        <div class="preset-color" data-color="#FECA57" style="background: #FECA57" title="ÈªÑ"></div>
                                        <div class="preset-color" data-color="#FF9FF3" style="background: #FF9FF3" title="„Éî„É≥„ÇØ"></div>
                                        <div class="preset-color" data-color="#54A0FF" style="background: #54A0FF" title="Á©∫Ëâ≤"></div>
                                        <div class="preset-color" data-color="#5F27CD" style="background: #5F27CD" title="Á¥´"></div>
                                        <div class="preset-color" data-color="#00D2D3" style="background: #00D2D3" title="„Ç∑„Ç¢„É≥"></div>
                                        <div class="preset-color" data-color="#FF9F43" style="background: #FF9F43" title="„Ç™„É¨„É≥„Ç∏"></div>
                                    </div>
                                    <div class="color-info">
                                        <span class="color-preview"></span>
                                        <input type="text" id="color-hex" placeholder="#RRGGBB" maxlength="7">
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="add-project-btn" class="btn btn-primary">Ê°à‰ª∂„ÇíËøΩÂä†</button>
                        </div>
                        
                        <div class="existing-projects-section">
                            <h4>Êó¢Â≠òÊ°à‰ª∂‰∏ÄË¶ß</h4>
                            <div id="projects-list">
                                <p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal">Èñâ„Åò„Çã</button>
                </div>
            </div>
        `;

        setupProjectManagerEventListeners(modal);
        loadExistingProjects();
        
        return modal;
    }

    function setupProjectManagerEventListeners(modal) {
        modal.querySelector('.close-btn').addEventListener('click', () => closeModal(modal));
        modal.querySelector('.close-modal').addEventListener('click', () => closeModal(modal));
        modal.querySelector('#add-project-btn').addEventListener('click', addNewProject);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(modal);
        });
        
        // „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        setupColorPicker(modal);
    }

    function setupColorPicker(modal) {
        const colorInput = modal.querySelector('#new-project-color');
        const colorPreview = modal.querySelector('.color-preview');
        const colorHex = modal.querySelector('#color-hex');
        const presetColors = modal.querySelectorAll('.preset-color');
        
        // ÂàùÊúü„Éó„É¨„Éì„É•„ÉºË®≠ÂÆö
        updateColorPreview(colorInput.value);
        
        // „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„ÅÆÂ§âÊõ¥
        colorInput.addEventListener('input', function() {
            updateColorPreview(this.value);
            colorHex.value = this.value;
        });
        
        // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„Åß„ÅÆËâ≤ÊåáÂÆö
        colorHex.addEventListener('input', function() {
            const color = this.value;
            if (/^#[0-9A-F]{6}$/i.test(color)) {
                colorInput.value = color;
                updateColorPreview(color);
            }
        });
        
        // „Éó„É™„Çª„ÉÉ„Éà„Ç´„É©„Éº„ÅÆ„ÇØ„É™„ÉÉ„ÇØ
        presetColors.forEach(preset => {
            preset.addEventListener('click', function() {
                const color = this.dataset.color;
                colorInput.value = color;
                colorHex.value = color;
                updateColorPreview(color);
                
                // ÈÅ∏ÊäûÁä∂ÊÖã„ÅÆË°®Á§∫
                presetColors.forEach(p => p.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
        
        function updateColorPreview(color) {
            colorPreview.style.backgroundColor = color;
            colorPreview.textContent = color;
        }
    }

    function loadExistingProjects() {
        kintone.api('/k/v1/records', 'GET', {
            app: kintone.app.getId(),
            query: `${FIELD_CODES.PROJECT_NAME} != "" order by ${FIELD_CODES.PROJECT_NAME} asc`
        }).then(response => {
            const projectsMap = new Map();
            
            response.records.forEach(task => {
                const projectName = task[FIELD_CODES.PROJECT_NAME] ? task[FIELD_CODES.PROJECT_NAME].value : '';
                const projectColor = (task[FIELD_CODES.PROJECT_COLOR] && task[FIELD_CODES.PROJECT_COLOR].value) || '';
                
                if (projectName && !projectsMap.has(projectName)) {
                    projectsMap.set(projectName, {
                        name: projectName,
                        color: projectColor || getDefaultProjectColor(projectName),
                        taskCount: 0
                    });
                }
                
                if (projectName) {
                    projectsMap.get(projectName).taskCount++;
                }
            });
            
            displayExistingProjects(Array.from(projectsMap.values()));
        }).catch(error => {
            console.error('Project loading error:', error);
            document.getElementById('projects-list').innerHTML = '<p style="color: red;">Ê°à‰ª∂„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
        });
    }

    function displayExistingProjects(projects) {
        const container = document.getElementById('projects-list');
        
        if (projects.length === 0) {
            container.innerHTML = '<p style="color: #666;">„Åæ„Å†Ê°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            return;
        }
        
        container.innerHTML = projects.map(project => `
            <div class="project-item">
                <div class="project-info">
                    <div class="project-color-indicator" style="background-color: ${project.color}"></div>
                    <div class="project-details">
                        <strong>${project.name}</strong>
                        <span class="task-count">${project.taskCount}‰ª∂„ÅÆ„Çø„Çπ„ÇØ</span>
                    </div>
                </div>
                <div class="project-actions">
                    <button class="btn-small btn-edit" onclick="editProject('${project.name}', '${project.color}')">Á∑®ÈõÜ</button>
                </div>
            </div>
        `).join('');
    }

    function addNewProject() {
        const projectName = document.getElementById('new-project-name').value.trim();
        const projectColor = document.getElementById('new-project-color').value;
        
        if (!projectName) {
            alert('Ê°à‰ª∂Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        
        console.log('Adding project:', projectName, projectColor);
        
        // Êó¢Â≠òÊ°à‰ª∂Âêç„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
        kintone.api('/k/v1/records', 'GET', {
            app: kintone.app.getId(),
            query: `${FIELD_CODES.PROJECT_NAME} = "${projectName}"`
        }).then(response => {
            if (response.records.length > 0) {
                alert('Âêå„ÅòÂêçÂâç„ÅÆÊ°à‰ª∂„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô');
                return;
            }
            
            // Ê°à‰ª∂Ë®≠ÂÆöÁî®„ÅÆ„ÉÄ„Éü„Éº„Çø„Çπ„ÇØ„Çí‰ΩúÊàêÔºàÂ≠òÂú®„Åô„Çã„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Åø‰ΩøÁî®Ôºâ
            const record = {};
            record[FIELD_CODES.TASK_NAME] = { value: `„ÄêÊ°à‰ª∂Ë®≠ÂÆö„Äë${projectName}` };
            record[FIELD_CODES.PROJECT_NAME] = { value: projectName };
            record[FIELD_CODES.START_DATE] = { value: new Date().toISOString() };
            record[FIELD_CODES.TASK_TYPE] = { value: TASK_TYPES.SINGLE };
            record[FIELD_CODES.STATUS] = { value: STATUS_TYPES.COMPLETED };
            record[FIELD_CODES.DESCRIPTION] = { value: `Ê°à‰ª∂„Äå${projectName}„Äç„ÅÆË®≠ÂÆöÊÉÖÂ†±„Åß„Åô„ÄÇ„Ç´„É©„Éº: ${projectColor}` };
            
            // ÂÑ™ÂÖàÂ∫¶„Å®„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„É©„Éº„Éï„Ç£„Éº„É´„Éâ„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
            if (FIELD_CODES.PRIORITY) {
                record[FIELD_CODES.PRIORITY] = { value: '‰Ωé' };
            }
            if (FIELD_CODES.PROJECT_COLOR) {
                record[FIELD_CODES.PROJECT_COLOR] = { value: projectColor };
            }
            
            return kintone.api('/k/v1/record', 'POST', {
                app: kintone.app.getId(),
                record: record
            });
        }).then(() => {
            document.getElementById('new-project-name').value = '';
            document.getElementById('new-project-color').value = '#4CAF50';
            
            showNotification(`Ê°à‰ª∂„Äå${projectName}„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ`, 'success');
            
            loadExistingProjects();
            loadInitialData(); // „Ç´„É¨„É≥„ÉÄ„Éº„ÇÇÊõ¥Êñ∞
            
        }).catch(error => {
            console.error('Project creation error:', error);
            showNotification('Ê°à‰ª∂„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || 'Unknown error'), 'error');
        });
    }

    // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
    window.editProject = function(projectName, projectColor) {
        const newName = prompt('Ê°à‰ª∂Âêç„ÇíÁ∑®ÈõÜ:', projectName);
        const newColor = prompt('Ê°à‰ª∂„Ç´„É©„ÉºÔºà#RRGGBBÂΩ¢ÂºèÔºâ:', projectColor);
        
        if (newName && newName !== projectName) {
            // Ê°à‰ª∂ÂêçÂ§âÊõ¥„ÅÆÂ†¥Âêà„ÄÅÂÖ®„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞
            updateAllTasksProject(projectName, newName, newColor || projectColor);
        } else if (newColor && newColor !== projectColor) {
            // Ëâ≤„ÅÆ„ÅøÂ§âÊõ¥
            updateProjectColor(projectName, newColor);
        }
    };

    function updateAllTasksProject(oldName, newName, newColor) {
        TaskAPI.getTasks({ project: oldName }).then(response => {
            const updatePromises = response.records.map(task => {
                return TaskAPI.updateTask(task.$id.value, {
                    [FIELD_CODES.PROJECT_NAME]: newName,
                    [FIELD_CODES.PROJECT_COLOR]: newColor
                });
            });
            
            return Promise.all(updatePromises);
        }).then(() => {
            showNotification(`Ê°à‰ª∂„Äå${oldName}„Äç„Çí„Äå${newName}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
            loadInitialData();
            loadExistingProjects();
        }).catch(error => {
            console.error('Project update error:', error);
            showNotification('Ê°à‰ª∂„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        });
    }

    function updateProjectColor(projectName, newColor) {
        TaskAPI.getTasks({ project: projectName }).then(response => {
            const updatePromises = response.records.map(task => {
                return TaskAPI.updateTask(task.$id.value, {
                    [FIELD_CODES.PROJECT_COLOR]: newColor
                });
            });
            
            return Promise.all(updatePromises);
        }).then(() => {
            showNotification(`Ê°à‰ª∂„Äå${projectName}„Äç„ÅÆËâ≤„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
            loadInitialData();
            loadExistingProjects();
        }).catch(error => {
            console.error('Project color update error:', error);
            showNotification('Ê°à‰ª∂Ëâ≤„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        });
    }

    function openTaskCreationDialog() {
        const url = `${location.origin}/k/${kintone.app.getId()}/edit`;
        window.open(url, '_blank');
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `;
        
        const colors = {
            success: '#28a745',
            error: '#dc3545', 
            warning: '#ffc107',
            info: '#007bff'
        };
        
        notification.style.backgroundColor = colors[type] || colors.info;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

})();